<style>
    .pay td
    {
        vertical-align: top;
    }
    .pay .odd
    {
        background-color: #ffffff;
    }
    .pay .even
    {
        background-color: #ffffff;
    }
    .bpay td
    {
        font-size: 18px;
        vertical-align: middle;
    }
    .epay
    {
    }
    .righttd
    {
        text-align: left;
    }
    .lefttd
    {
        text-align: right;
    }
    input
    {
        border: 2px solid #528082;
    }
</style>
@model EcardModelItem<ChangeNameAccount>
<div class="place">
    <span>位置：</span>
    <ul class="placeul">
        <li><a href="#">首页</a></li>
        <li><a href="#">@Model.Localize("title")</a></li>
    </ul>
</div>
<div class="formbody">
    <ul class="forminfo" id="operationPanel">
        <li>
            <label id="accountInput">
                @Model.Localize("Name.Name")</label><input id="oldAccountName"   data-field="oldAccountName" tabindex="1" maxlength="@Model.Site.AccountNameLength" type="text" class="scinput InputSerach">
        </li>
        <li id="newAccountInfo">
            <label>
                @Model.Localize("NewAccountName.Name")</label><input id="accountName"   data-field="accountName" tabindex="1" maxlength="@Model.Site.AccountNameLength" type="text" class="scinput InputSerach">
            <input type="hidden" data-field="accountToken" value="@Model.Site.AccountToken" />
        </li>
        <li>
            <label>
                &nbsp;</label>
            <button id="btnQuery" class="scbtn" style="width: 70px;height: 25px" href="../Account/QueryWithUserInfo"  data-waiting-message='@Model.Localize("waitingForQuery")'>@Model.Localize("Query.Text")</button>
            <button id="btnRecharging" class="scbtn" style="width: 70px;height: 25px" href="../Account/changeName"  data-waiting-message='@Model.Localize("waitingForCommunicate")' data-success-message='@Model.Localize("success")'>@Model.Localize("Change.Text")</button></li>
        <li>
            <label>
                &nbsp;</label>
            <p id="numbermsg">
            </p>
        </li>
        <li style="border-bottom-style: solid; border-bottom-width: thin; border-bottom-color: #99CCFF;
            border-top-style: solid; border-top-width: thin; border-top-color: #99CCFF;"
            align="center">
            <table id="accountMsg">
                <tr>
                    <td colspan="2">
                        &nbsp;
                    </td>
                    <td colspan="2">
                        会员信息
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="righttd">
                        <label>
                            卡号:
                        </label>
                        <input type="text" data-field="AccountName" disabled="disabled" tabindex="1" maxlength="16"
                            value="" class="scinput InputSerach" />
                    </td>
                    <td colspan="2" class="lefttd">
                        <label style="text-align: left; padding-left: 45px; width: 30px">
                            金额:
                        </label>
                        <input type="text" data-field="Amount" disabled="disabled" tabindex="1" maxlength="16"
                            value="" class="scinput InputSerach" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>
                            姓名:
                        </label>
                    </td>
                    <td>
                        <input type="text" data-field="OwnerDisplayName" disabled="disabled" tabindex="1"
                            maxlength="16" value="" class="scinput InputSerach" />
                    </td>
                    <td>
                        <label style="text-align: left; padding-left: 45px; width: 30px">
                            积分:
                        </label>
                    </td>
                    <td>
                        <input type="text" data-field="Point" disabled="disabled" tabindex="1" maxlength="16"
                            value="" class="scinput InputSerach" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>
                            有效期:
                        </label>
                    </td>
                    <td>
                        <input type="text" data-field="ExpiredDate" disabled="disabled" tabindex="1" maxlength="16"
                            value="" class="scinput InputSerach" />
                    </td>
                    <td>
                        <label style="text-align: left; padding-left: 45px; width: 30px">
                            相片:
                        </label>
                    </td>
                    <td>
                        <img width="120" data-field="Photo" data-field-format="@Paths.UserPhotoFormat" />
                    </td>
                </tr>
            </table>
        </li>
    </ul>
</div>
@*<div class="paydiv">
    <table class="pay" id="operationPanel">
        <tr class="bpay" id="oldAccountInfo">
            <div id="accountInput">
                <td class="lefttd">
                    @Model.Localize("Name.Name"):
                </td>
                <td class="righttd" colspan="2">
                    <input type="text" id="oldAccountName" data-field="oldAccountName" tabindex="1" value="" maxlength="@Model.Site.AccountNameLength" class="field text full">
                </td>
            </div>
        </tr>
        <tr class="bpay" id="newAccountInfo">
            <td class="lefttd">
                <label>
                    @Model.Localize("NewAccountName.Name"):
                </label>
            </td>
            <td class="righttd">
                <input type="text" id="accountName" data-field="accountName" tabindex="1"  maxlength="@Model.Site.AccountNameLength" value="" class="field text full">
                <input type="hidden" data-field="accountToken" value="@Model.Site.AccountToken" />
            </td>
        </tr>
        <tr class="buttons">
            <td colspan="2">
                <button id="btnQuery" class="ui-state-default ui-corner-all" href="../Account/QueryWithUserInfo"  data-waiting-message='@Model.Localize("waitingForQuery")'>@Model.Localize("Query.Text")</button>
            </td>
            <td colspan="2">
                <button id="btnRecharging" class="ui-state-default ui-corner-all" href="../Account/changeName"  data-waiting-message='@Model.Localize("waitingForCommunicate")' data-success-message='@Model.Localize("success")'>@Model.Localize("Change.Text")</button>
            </td>
        </tr>
        <tr class="epay">
            <td colspan="4">
                <div align="center">
                    <p id="numbermsg">
                    </p>
                </div>
            </td>
        </tr>
        <div class="portlet form-bg ui-widget ui-widget-content ui-helper-clearfix ui-corner-all account-info" id="@Model">
            <tr>
                <td colspan="4">
                    <div style="margin-top: 15px; border-bottom-style: solid; border-bottom-width: thin;
                        border-bottom-color: #99CCFF; border-top-style: solid; border-top-width: thin;
                        border-top-color: #99CCFF;" align="center">
                        会员信息</div>
                </td>
            </tr>
            <tr class="epay">
                <td class="lefttd">
                    卡号
                </td>
                <td class="righttd">
                    <input type="text" data-field="oldAccountName" disabled="disabled" tabindex="1" maxlength="16"
                        value="" class="field text full" />
                </td>
                <td class="lefttd">
                    金额
                </td>
                <td class="righttd">
                    <input type="text" data-field="Amount" disabled="disabled" tabindex="1" maxlength="16"
                        value="" class="field text full" />
                </td>
            </tr>
            <tr class="epay">
                <td class="lefttd">
                    姓名
                </td>
                <td class="righttd">
                    <input type="text" data-field="OwnerDisplayName" disabled="disabled" tabindex="1"
                        maxlength="16" value="" class="field text full" />
                </td>
                <td class="lefttd">
                    积分
                </td>
                <td class="righttd">
                    <input type="text" data-field="Point" disabled="disabled" tabindex="1" maxlength="16"
                        value="" class="field text full" />
                </td>
            </tr>
            <tr class="epay">
                <td class="lefttd">
                    有效期
                </td>
                <td class="righttd">
                    <input type="text" data-field="ExpiredDate" disabled="disabled" tabindex="1" maxlength="16"
                        value="" class="field text full" />
                </td>
                <td class="lefttd">
                    相片
                </td>
                <td class="righttd">
                    <img width="120" data-field="Photo" data-field-format="@Paths.UserPhotoFormat" />
                </td>
            </tr>
        </div>
    </table>
</div>*@
<div id="dialog" class="hastable" style="display: none">
    <table>
        <thead>
            <tr>
                <th>
                    卡号
                </th>
                <th>
                    姓名
                </th>
                <th>
                    手机号
                </th>
                <th>
                    身份证
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<script>
    (function ($) {
        var btn = $("#btnQuery");
        $("#numbermsg").text('@Model.Localize("waitingForInsertCard")');

        $(function () {
            //查询
            btn.click(function () {
                var $this = $(this);
                $("#numbermsg").css("color", "red");

                var account = $("#accountInput").bindto();
                account.accountName = $("#oldAccountName").val();
                //            if (!account.accountName || account.accountName.trim().length != @Model.Site.AccountNameLength)   
                //   
                //                account = readAccount();        
                //              }


                if (account == null) {

                    $("#numbermsg").text('@Model.Localize("卡号不存在")');

                    return;
                }
                if (account.accountName) {

                    $("#accountInput").bindfrom(account);
                }

                //                 if (account.accountName.trim().length != @Model.Site.AccountNameLength) {
                //                        $("#numbermsg").text('@Model.Localize("请输入卡号")');
                //                              return;
                //                 }


                $("#numbermsg").css("color", "");
                $("#numbermsg").text($(this).attr("data-waiting-message"));
                $.post($(this).attr("href") + "?tm=" + new Date(), account
                    , function (data, status) {

                        if (status == "success") {
                            $("[data-field='AccountName']").val(data.OldAccountName);

                            $("[data-field='Amount']").val(data.Amount);
                            $("[data-field='ExpiredDate']").val(data.ExpiredDate);
                            $("[data-field='OwnerDisplayName']").val(data.OwnerDisplayName);
                            $("[data-field='Point']").val(data.Point);
                            $("[data-field='Photo']").attr("src", "/content/userphotos/" + data.Photo);
                            if (data.Code != 0) {
                                $("#numbermsg").css("color", "red");
                                $("#numbermsg").text(data.CodeText);

                            }
                            else {
                                $("#numbermsg").css("color", "green");
                                $("#currentAmount").val("0");

                                $("[data-field='oldAccountName']").val(data.AccountName);
                                if ($this.attr("data-print") == 'true') {
                                    alert("操作成功");
                                    printTicket2(data.CodeText);
                                } else
                                    alert(data.CodeText);
                            }
                        }
                    });
            });
        });
    })(jQuery);
</script>
<script>
    function fillAccount(accountName) {
        $("#oldAccountName").val(accountName);
        $("#btnQuery").trigger("click");
        $("#dialog").dialog("close");
    }
    (function ($) {
        $("#numbermsg").text('@Model.Localize("waitingForInsertCard")');
        $(function (p) {
            //换卡
            $("#btnRecharging").click(function () {

                $("#accountInfo").bindfrom({});

                $("#numbermsg").css("color", "red");

                var $this = $(this);

                var account = readAccount();
                if (account == null) {
                    $("#numbermsg").text('@Model.Localize("failToReadAccount")');
                    return;
                }


                if (account.accountName) {
                    $("#accountInfo").bindfrom(account);
                }

                var model = new Object();
                model.AccountName = $("#accountName").val();
                model.OldAccountName = $("#oldAccountName").val();
                $this.attr("disabled", "disabled");

                $("#numbermsg").text($this.attr("data-waiting-message"));

                //$.post($(this).attr("href") + "?tm=" + new Date(), $("#accountInput").bindto()
                $.post($(this).attr("href") + "?tm=" + new Date(), model
                    , function (data) {
                        $("#accountInfo").bindfrom(data);
                        if (data.Code == 0) {
                            $("#numbermsg").css("color", "green").text("换卡成功！");
                            printTicket(data.CodeText);
                        } else {
                            $("#numbermsg").css("color", "red").text(data.CodeText);
                        }
                        $this.attr("disabled", false);
                    });
            });


            $("#btnQuery").click(function () {

                $("#accountInfo").bindfrom({});

                $("#numbermsg").css("color", "red");
                var $this = $(this);

                $this.attr("disabled", "disabled");
                $("#numbermsg").text($this.attr("data-waiting-message"));
                $.post($(this).attr("href") + "?tm=" + new Date(), { accountName: $("#oldAccountName").val() }
                    , function (data) {
                        if (data.length > 0) {
                            $("#numbermsg").text('@Model.Localize("pleaseChoiceAccount")');
                            $("tbody", $("#dialog")).empty();
                            $(data).each(function () {
                                var tr = String.format("<tr ondblclick='fillAccount(\"{0:AccountName}\");'><td>{0:AccountName}</td><td>{0:OwnerDisplayName}</td><td>{0:OwnerMobile}</td><td>{0:OwnerIdentity}</td></tr>", this);
                                $("tbody", $("#dialog")).append(tr);
                            });
                            $("#dialog").dialog({
                                resizable: false,
                                autoOpen: true,
                                width: 600,
                                modal: false,
                                buttons: {
                                    "确定": function () {
                                        $(this).dialog("close");
                                    }
                                }
                            });
                        } else {
                            $("#numbermsg").text(data.CodeText);
                            $("#accountInfo").bindfrom(data);
                            if (data.Code == 0) {
                                $("#oldAccountName").val(data.AccountName);

                                $("#numbermsg").css("color", "green");

                                if ($this.attr("data-success-message"))
                                    alert($this.attr("data-success-message"));
                            } else {
                                $("#numbermsg").css("color", "red");
                            }
                        }
                        $this.attr("disabled", false);
                    });
            });
        });
    })(jQuery);
</script>
