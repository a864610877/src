@{


}
@model EcardModelItem<Ecard.Mvc.Models.Shops.WindowTicketingView>
   
        <div class="place">
            <span>位置：</span>
            <ul class="placeul">
                <li><a href="#">首页</a></li>
                <li><a href="#">窗口售票</a></li>
            </ul>
        </div>
        <div class="create_div">
            <ul class="forminfo" style="padding-top:10px;">
                <li>
                    <label><label class="desc" for="Item_AccountType">门票</label></label>
                    <div class="vocation">
                        <div class="uew-select">
                            <div class="uew-select-value ue-state-default">
                                <em class="uew-select-text"></em><em class="uew-icon uew-icon-triangle-1-s"></em>
                            </div>
                            <select class="select1" data-val="true" data-val-number="The field Key must be a number." data-val-required="请输入必填字段" id="AdmissionTicket" name="AdmissionTicket">
                                <option value="0" data-prie="0" selected></option>
                                @foreach (var item in Model.Item.AdmissionTicket)
                                {
                                    <option value="@item.Key" data-prie="@item.value">@item.Name</option>
                                }
                            </select>
                        </div>
                    </div><span class="field-validation-valid" data-valmsg-for="Item.AccountType.Key" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_Start">价格</label></label>
                    <input class="scinput InputSerach" data-val="true" data-val-number="The field Start must be a number." data-val-required="Start 字段是必需的。" id="price" name="price" type="text" value="0" disabled>
                    <span class="field-validation-valid" data-valmsg-for="Item.Start" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_Password">数量</label></label>
                    <input class="scinput InputSerach" id="num" name="num" type="text" value="1">
                    <span class="field-validation-valid" data-valmsg-for="Item.Password" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_Password">折扣</label></label>
                    <input class="scinput InputSerach" id="discount" name="discount" type="text" value="1">
                    <span class="field-validation-valid" data-valmsg-for="Item.Password" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_End">姓名</label></label>
                    <input class="scinput InputSerach" data-val="true" data-val-number="The field End must be a number." data-val-required="姓名" id="displayName" name="displayName" type="text" value="">
                    <span class="field-validation-valid" data-valmsg-for="Item.End" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_Interval">手机号</label></label>
                    <input class="scinput InputSerach" data-val="true" data-val-number="The field Interval must be a number." data-val-required="" id="mobile" name="mobile" type="text" value="">
                    <span class="field-validation-valid" data-valmsg-for="Item.Interval" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_End">宝宝姓名</label></label>
                    <input class="scinput InputSerach" data-val="true" data-val-number="The field End must be a number." data-val-required="宝宝姓名" id="babyName" name="babyName" type="text" value="">
                    <span class="field-validation-valid" data-valmsg-for="Item.End" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_AccountType">宝宝性别</label></label>
                    <div class="vocation">
                        <div class="uew-select">
                            <div class="uew-select-value ue-state-default">
                                <em class="uew-select-text"></em><em class="uew-icon uew-icon-triangle-1-s"></em>
                            </div>
                            <select class="select1" data-val="true" data-val-number="The field Key must be a number." data-val-required="请输入必填字段" id="babySex" name="babySex">
                                <option value="0" selected></option>
                                @foreach (var item in Model.Item.BabySex)
                                {
                                    <option value="@item.Key" data-prie="@item.value">@item.Name</option>
                                }
                            </select>
                        </div>
                    </div><span class="field-validation-valid" data-valmsg-for="Item.AccountType.Key" data-valmsg-replace="true"></span>
                </li>


                <li>
                    <label><label class="desc" for="Item_AccountToken">宝宝出生年月</label></label>
                    <input class="Wdate scinput" id="babyBirthDate" name="babyBirthDate" onfocus="WdatePicker({startDate:'%y-%M-01 00:00:00',dateFmt:'yyyy-MM-dd HH:mm:ss',alwaysUseStartDate:true})" type="text" value="">
                    <span class="field-validation-valid" data-valmsg-for="Item.AccountToken" data-valmsg-replace="true"></span>
                </li>
                <li>
                    <label><label class="desc" for="Item_AccountType">支付方式</label></label>
                    <div class="vocation">
                        <div class="uew-select">
                            <div class="uew-select-value ue-state-default">
                                <em class="uew-select-text"></em><em class="uew-icon uew-icon-triangle-1-s"></em>
                            </div>
                            <select class="select1" data-val="true" data-val-number="The field Key must be a number." data-val-required="请输入必填字段" id="PayType" name="PayType">
                                <option value="0" selected></option>
                                @foreach (var item in Model.Item.PayType)
                                {
                                    <option value="@item.Key" data-prie="@item.value">@item.Name</option>
                                }
                            </select>
                        </div>
                    </div><span class="field-validation-valid" data-valmsg-for="Item.AccountType.Key" data-valmsg-replace="true"></span>
                </li>


            </ul>
            <div style=" clear:both" />
            <div class="submitDiv"> <input type="button" id="sp" class="scbtn" value="售 票" /></div>
        </div>
        <script src="/js/LodopFuncs.js"></script>
        <script type="text/javascript">
            $(function () {
                $(".create_field input").focus(function () {
                    $("[forprop='" + $(this).attr("id") + "']").show("1500");
                });
                $(".create_field select").click(function () {
                    $("[forprop='" + $(this).attr("id") + "_Key']").show("1500");
                });
                $(".create_field input").blur(function () {
                    $("[forprop='" + $(this).attr("id") + "']").hide("1500");
                });
                $(".create_field select").mouseleave(function () {
                    $("[forprop='" + $(this).attr("id") + "_Key']").hide("1500");
                });
                $("#AdmissionTicket").change(function () {
                    jsjg();
                });
                $("#num").change(function () {
                    jsjg();
                })
                function jsjg() {
                    var num = parseInt($("#num").val());
                    var price = parseFloat($("#AdmissionTicket").find("option:selected").attr("data-prie"));
                    if (num > 0) {

                    } else {
                        num = 0;
                    }
                    if (price > 0) {

                    } else {
                        price = 0;
                    }
                    $("#price").val(num * price);
                }

                $("#sp").click(function () {

                    //Print();
                    //return;
                    var admissionTicketId = $("#AdmissionTicket").val();
                    var babyBirthDate = $("#babyBirthDate").val();
                    var babyName = $("#babyName").val();
                    var babySex = $("#babySex").val();
                    var displayName = $("#displayName").val();
                    var mobile = $("#mobile").val();
                    var num = $("#num").val();
                    var payType = $("#PayType").val();
                    var discount = $("#discount").val();

                    $.ajax({
                        url: "/shop/WindowTicketing",
                        data: { admissionTicketId: admissionTicketId, babyBirthDate: babyBirthDate, babyName: babyName, babySex: babySex, displayName: displayName, mobile: mobile, num: num, payType: payType, discount: discount},
                        type: "post",
                        dataType: "json",
                        success: function (data) {
                            if (data.Code == 0) {
                                alert("售票成功");
                                $("#babyName").val('');
                                $("#babyBirthDate").val('');
                                $("#displayName").val('');
                                $("#mobile").val('');
                                $("#num").val(0);
                                $("#price").val(0);
                                if (data.data != null && data.data.length > 0) {
                                    for (var i = 0; i < data.data.length; i++) {
                                        Print(data.data[i]);
                                    }
                                }
                            } else {
                                alert(data.CodeText);
                            }
                        },
                        error: function () {
                            alert("系统异常，请检查网络");
                        }
                    })
                });

                function Print(item) {

                    // var src = "1234567890";
                    // jq(item.name);
                    //return;
                    var copies = 1;
                    var pIndex = 0;
                    var pTitle = "手环打印";
                    LODOP = getLodop();
                    try {
                        LODOP = getLodop();
                        if (LODOP.VERSION) {
                            //if (LODOP.CVERSION)
                            //    alert("当前有C-Lodop云打印可用!\n C-Lodop版本:"+LODOP.CVERSION+"(内含Lodop"+LODOP.VERSION+")"); 
                            //else
                            //    alert("本机已成功安装了Lodop控件！\n 版本号:"+LODOP.VERSION); 
                        };
                    } catch (err) {
                        if (confirm("您的打印控件安装有问题\n是否打开打印设置页面进行设置")) {
                            window.open("/Shop/Profile/SetPrinter");
                        }
                    }
                    if (LODOP.PRINT_INIT("手环打印") == false) {
                        alert("打印机初始划失败请检查");
                    }
                    LODOP.SET_PRINTER_INDEX(-1);
                    //PageWidth //PageHeight
                    // LODOP.SET_PRINT_PAGESIZE(2, "260mm", "26mm", "");//横向
                    //Top //Left //内容Width //内容Height //内容
                    // LODOP.ADD_PRINT_TEXT("13mm", "130mm", "100mm", "5mm", '333');//横向设置

                    LODOP.SET_PRINT_PAGESIZE(1, "26mm", "260mm", "");//这里1表示纵向打印且纸高
                    //姓名
                    var h = 125;
                    var w = 0.5;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '姓');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '名');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '：');//纵向设置
                    var arrName = jq(item.name);
                    h += 5;//换行
                    w = 0.5;
                    for (var i = 0; i < arrName.length; i++) {
                        if (i > 0) {
                            w += 3;
                        }
                        LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", arrName[i]);//纵向设置
                    }
                    //电话
                    h += 5;
                    w = 0.5;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '电');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '话');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '：');//纵向设置
                    var arrMobile = jq(item.mobile);
                    h += 5;//换行
                    w = 0.5;
                    for (var i = 0; i < arrMobile.length; i++) {
                        if (i > 0) {
                            w += 3;
                        }
                        if (i == 6) {
                            h += 5;
                            w = 0.5;
                        }
                        LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", arrMobile[i]);//纵向设置
                    }

                    //进场时间
                    h += 5;
                    w = 0.5;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '进');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '场');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '时');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '间');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '：');//纵向设置
                    var arrEinlass = jq(item.einlass);
                    h += 5;//换行
                    w = 0.5;
                    for (var i = 0; i < arrEinlass.length; i++) {
                        if (i > 0) {
                            w += 3;
                        }
                        if (i == 6) {
                            h += 5;
                            w = 0.5;
                        }
                        LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", arrEinlass[i]);//纵向设置
                    }

                    //离场时间
                    h += 5;
                    w = 0.5;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '离');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '场');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '时');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '间');//纵向设置
                    w += 3;
                    LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", '：');//纵向设置
                    var arreffectiveTime = jq(item.effectiveTime);
                    h += 5;//换行
                    w = 0.5;
                    for (var i = 0; i < arreffectiveTime.length; i++) {
                        if (i > 0) {
                            w += 3;
                        }
                        if (i == 6) {
                            h += 5;
                            w = 0.5;
                        }
                        LODOP.ADD_PRINT_TEXT(h + "mm", w + "mm", "5mm", "100mm", arreffectiveTime[i]);//纵向设置
                    }



                    //LODOP.SET_PRINT_PAGESIZE(1, 100, 60, "");
                    // LODOP.SET_PRINT_COPIES(copies);//打印份数
                    //LODOP.ADD_PRINT_BARCODE(130, 455, 200, 100, "QRCode", obj.Number);
                    //LODOP.ADD_PRINT_TEXT(500, 5, 5, 300, '姓');
                    //LODOP.ADD_PRINT_TEXT(505, 5, 5, 300, '名');
                    //LODOP.SET_PRINT_STYLE("Angle",90);
                    // top  //left  


                    // LODOP.ADD_PRINT_TEXT("130mm", "13mm", "5mm", "100mm", '333');//纵向设置
                    //LODOP.ADD_PRINT_TEXT("130mm", "13mm", "5mm", "100mm", '333');
                    //LODOP.ADD_PRINT_TEXT(500, 5, 0, 0, '姓名：' + item.name);
                    //LODOP.ADD_PRINT_TEXT(500, 5, 0, 0, '姓名：' + item.name);
                    //LODOP.ADD_PRINT_TEXT(500, 25, 5, 300, '电话：' + item.mobile);
                    //LODOP.ADD_PRINT_TEXT(500, 45, 5, 350, '进场时间：' + item.einlass);
                    //LODOP.ADD_PRINT_TEXT(500, 65, 5, 350, '离场时间：' + item.effectiveTime);
                    LODOP.PRINT();
                    // $('#table').bootstrapTable('removeAll');
                    // setTotal()
                }

                function jq(str) {
                    var arr = new Array();
                    var count = str.length;
                    var start = 0;
                    for (var i = 0; i < count; i++) {
                        arr.push(str.substring(i, i + 1));
                    }
                    return arr;
                }

            });

        </script>
